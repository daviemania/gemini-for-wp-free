services:
    gemini-dev:
        build:
            context: .
            dockerfile: .devcontainer/Dockerfile
            args:
                USER_UID: 1000
                USER_GID: 1000

        container_name: gemini-project-dev

        # Use tmux session for long-running processes
        command: >
            sh -c "tmux new-session -d -s ai-dev 'sleep infinity' &&
                   exec sleep infinity"

        volumes:
            # Main workspace
            - .:/gemini-project:cached
            # Preserve npm cache
            - npm-cache:/home/bitnami/.npm-global
            # Mount .env file
            - ./.env:/gemini-project/.env:ro

        working_dir: /gemini-project

        # Run as bitnami user (matching host UID/GID)
        user: bitnami

        # Load environment variables
        env_file:
            - .env

        # Host networking for unrestricted access
        network_mode: host

        # Resource limits
        deploy:
            resources:
                limits:
                    memory: 3G
                    cpus: "2.0"
                reservations:
                    memory: 512M

        # Restart policy
        restart: unless-stopped

        # Keep stdin open and allocate TTY for tmux
        stdin_open: true
        tty: true

        # Health check
        healthcheck:
            test: ["CMD", "tmux", "ls"]
            interval: 30s
            timeout: 10s
            retries: 3

volumes:
    npm-cache:
        driver: local

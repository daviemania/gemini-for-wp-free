name: Freemius Plugin Deploy

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:

jobs:
    build-zip:
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Run Gitleaks Secret Scan
              uses: gitleaks/gitleaks-action@v2
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              continue-on-error: false

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: ./gemini-mcp-tools/package-lock.json

            - name: Install production dependencies
              run: npm ci --only=production
              working-directory: ./gemini-mcp-tools

            - name: Create plugin ZIP
              run: |
                  # Define variables
                  PLUGIN_DIR="gemini-mcp-tools"
                  ZIP_NAME="${PLUGIN_DIR}-${{ github.ref_name }}.zip"

                  # Change into the plugin directory
                  cd $PLUGIN_DIR

                  # Create ZIP from inside the plugin directory
                  # This ensures clean structure: gemini-mcp-tools/* in the ZIP
                  zip -r ../$ZIP_NAME . \
                    -x "vendor/freemius/*" \
                    -x "tests/*" "test/*" "__tests__/*" \
                    -x ".git*" ".github/*" \
                    -x ".env*" ".env.example" \
                    -x "freemius-gate.php~" \
                    -x "phpunit.xml*" \
                    -x "package-lock.json" "yarn.lock" \
                    -x ".DS_Store" "Thumbs.db" \
                    -x "*.log" \
                    -x "node_modules/.cache/*"

                  # Move back to root and save ZIP name
                  cd ..
                  echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

                  # Verify ZIP contents (for debugging)
                  echo "=== ZIP Contents Preview ==="
                  unzip -l $ZIP_NAME | head -20
              shell: bash

            - name: Upload ZIP Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: gemini-mcp-tools-plugin-${{ github.ref_name }}
                  path: ${{ env.ZIP_NAME }}
                  retention-days: 30

    deploy:
        needs: build-zip
        runs-on: ubuntu-latest
        steps:
            - name: Download ZIP
              uses: actions/download-artifact@v4
              with:
                  name: gemini-mcp-tools-plugin-${{ github.ref_name }}
                  path: ./artifacts

            - name: Deploy to Freemius
              uses: buttonizer/freemius-deploy@v0.1.3
              with:
                  freemius-api-token: ${{ secrets.FREEMIUS_API_TOKEN }}
                  plugin-zip: ./artifacts/gemini-mcp-tools-${{ github.ref_name }}.zip

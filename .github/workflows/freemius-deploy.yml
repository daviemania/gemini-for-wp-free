- name: Create plugin ZIP
        run: |
          # Define variables
          PLUGIN_DIR="gemini-mcp-tools"
          ZIP_NAME="${name: Freemius Plugin Deploy

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-zip:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: false

      - name: Extract version from tag
        id: get_version
        run: |
          # Remove 'v' prefix from tag (v1.0.9 -> 1.0.9)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

      - name: Create plugin ZIP
        run: |
          # Define variables
          PLUGIN_DIR="gemini-mcp-tools"
          ZIP_NAME="${PLUGIN_DIR}.zip"
          
          # Change into the plugin directory
          cd $PLUGIN_DIR
          
          # Create production ZIP
          # Include vendor/ with Freemius SDK directly inside it
          zip -r ../$ZIP_NAME . \
            -x "node_modules/*" \
            -x "tests/*" "test/*" "__tests__/*" \
            -x ".git*" ".github/*" \
            -x ".env*" ".env.example" \
            -x "freemius-gate.php~" \
            -x "phpunit.xml*" \
            -x "package.json" "package-lock.json" "yarn.lock" \
            -x ".DS_Store" "Thumbs.db" \
            -x "*.log"
          
          # Move back to root
          cd ..
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
          
          # Verify ZIP contents and structure
          echo "=== ZIP Root Structure (plugin files at root level) ==="
          unzip -l $ZIP_NAME | head -30
          echo ""
          echo "=== Vendor Directory Check ==="
          unzip -l $ZIP_NAME | grep "vendor/" | head -15
          echo ""
          echo "=== Freemius SDK Check ==="
          unzip -l $ZIP_NAME | grep "vendor/start.php" && echo "✓ Freemius SDK found" || echo "⚠️ vendor/start.php not found"
        shell: bash

      - name: Upload ZIP Artifact
        uses: actions/upload-artifact@v4
        with:
          name: gemini-mcp-tools-plugin
          path: gemini-mcp-tools.zip
          retention-days: 30

  deploy:
    needs: build-zip
    runs-on: ubuntu-latest
    steps:
      - name: Download ZIP
        uses: actions/download-artifact@v4
        with:
          name: gemini-mcp-tools-plugin
          path: .

      - name: Extract version from tag
        id: get_version
        run: |
          # Remove 'v' prefix from tag (v1.0.9 -> 1.0.9)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

      - name: Deploy to Freemius
        id: freemius_deploy
        uses: buttonizer/freemius-deploy@v0.1.3
        with:
          file_name: gemini-mcp-tools.zip
          version: ${{ steps.get_version.outputs.VERSION }}
          release_mode: pending  # Options: pending, beta, released
          sandbox: false
        env:
          PUBLIC_KEY: ${{ secrets.FREEMIUS_PUBLIC_KEY }}
          DEV_ID: ${{ secrets.FREEMIUS_DEV_ID }}
          SECRET_KEY: ${{ secrets.FREEMIUS_SECRET_KEY }}
          PLUGIN_SLUG: ${{ secrets.FREEMIUS_PLUGIN_SLUG }}
          PLUGIN_ID: ${{ secrets.FREEMIUS_PLUGIN_ID }}

      - name: Upload Freemius Versions as Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: freemius-versions
          path: |
            ${{ steps.freemius_deploy.outputs.free_version }}
            ${{ steps.freemius_deploy.outputs.pro_version }}
          retention-days: 30
          if-no-files-found: ignore
